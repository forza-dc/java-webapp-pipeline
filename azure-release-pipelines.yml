trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  servicePrincipalId: 'your-service-principal-id'
  servicePrincipalKey: 'your-service-principal-key'
  tenantId: 'your-tenant-id'
  subscriptionId: 'your-subscription-id'

stages:
  - stage: Dev
    jobs:
      - job: DeployToDev
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'ForzaAzureRMConnection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az login --service-principal -u $(servicePrincipalId) -p $(servicePrincipalKey) --tenant $(tenantId)
                az account set --subscription $(subscriptionId)
                terraform init -input=false Infra-Folder
                terraform apply -input=false -auto-approve Infra-Folder

          - task: Kubernetes@1
            inputs:
              connectionType: 'Azure Resource Manager'
              azureSubscriptionEndpoint: 'ForzaAzureRMConnection'
              namespace: 'dev'
              command: 'apply'
              useConfigurationFile: true
              configurationType: 'yaml'
              configuration: '$(System.DefaultWorkingDirectory)/k8s/deployment.yaml'
            displayName: 'Deploy to Kubernetes'

  - stage: Prod
    jobs:
      - deployment: DeployToProd
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  inputs:
                    azureSubscription: 'ForzaAzureRMConnection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az login --service-principal -u $(servicePrincipalId) -p $(servicePrincipalKey) --tenant $(tenantId)
                      az account set --subscription $(subscriptionId)
                      terraform init -input=false Infra-Folder
                      terraform apply -input=false -auto-approve Infra-Folder

                - task: Kubernetes@1
                  inputs:
                    connectionType: 'Azure Resource Manager'
                    azureSubscriptionEndpoint: 'ForzaAzureRMConnection'
                    namespace: 'prod'
                    command: 'apply'
                    useConfigurationFile: true
                    configurationType: 'yaml'
                    configuration: '$(System.DefaultWorkingDirectory)/k8s/deployment.yaml'
                  displayName: 'Deploy to Kubernetes'
